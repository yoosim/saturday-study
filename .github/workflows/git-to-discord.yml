name: Git â†’ Discord (general git card)

on:
  push:
    branches: [ main ]
    paths:
      - "study/**"            # ì œì¶œ í´ë”ë§Œ ì•Œë¦¼ (ì „ì²´ ì•Œë¦¼ ì›í•˜ë©´ ì´ ì¤„ ì‚­ì œ)
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches: [ main ]
    paths:
      - "study/**"

jobs:
  notify:
    # PRì€ mergeëœ ê²½ìš°ì—ë§Œ ì¹´ë“œ ë°œì†¡ (ë…¸ì´ì¦ˆ ê°ì†Œ)
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
       github.event.action == 'closed' &&
       github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Post to Discord (git card)
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GIT_URL }}   # â† ê¹ƒ ì•Œë¦¼ ì±„ë„ ì›¹í›… (ì˜¤íƒ€ ì£¼ì˜!)
        run: |
          python - <<'PY'
          import os, json, requests
          ev = os.environ.get("GITHUB_EVENT_NAME","")
          ref = os.environ.get("GITHUB_REF_NAME","")
          actor = os.environ.get("GITHUB_ACTOR","")
          pr_url = os.environ.get("GITHUB_EVENT_PULL_REQUEST_HTML_URL","")
          # github.* ì»¨í…ìŠ¤íŠ¸ëŠ” envë¡œ ì§ì ‘ ì•ˆ ë“¤ì–´ì˜¤ë¯€ë¡œ ì•„ë˜ 3ì¤„ë¡œ ìµœëŒ€í•œ í¬ê´„
          link = os.environ.get("GITHUB_SERVER_URL","") + "/" + os.environ.get("GITHUB_REPOSITORY","")
          # ìš°ì„ ìˆœìœ„: PR ë§í¬ > compare ë§í¬ > repo ë§í¬
          compare = os.environ.get("GITHUB_EVENT_COMPARE","")
          if compare: link = compare
          if pr_url: link = pr_url
          content = f"ğŸ“¦ {ev} on `{ref}` by **{actor}**\n{link}"
          r = requests.post(os.environ["WEBHOOK"], json={"content": content}, timeout=20)
          print("status:", r.status_code, r.text[:200])
          r.raise_for_status()
          PY
